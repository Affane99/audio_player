<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture de son</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>

<body>

    <div class="bg-gray-100 p-4 flex h-screen gap-3 flex-wrap">
        <div class="bg-white p-8 rounded-lg shadow-md w-full md:w-80">
            <!-- Album Cover -->
            <img src="https://canto-wp-media.s3.amazonaws.com/app/uploads/2019/11/19191845/audio-file-types-32.jpg"
                alt="idk - Highvyn, Taylor Shin" class="w-64 h-64 mx-auto rounded-lg mb-4 shadow-lg shadow-red-50">
            <!-- Song Title -->
            <h2 class="text-xl font-semibold text-red-500 text-center" id="songTitle">Song Title</h2>
            <!-- Artist Name -->
            <p class="text-gray-600 text-sm text-center" id="artistName">Artist Name</p>
            <!-- Music Controls -->
            <div class="mt-6 flex justify-center items-center">
                <button class="p-3 rounded-full bg-gray-200 hover:bg-gray-300 focus:outline-none" id="prev">
                    <svg width="64px" height="64px" class="w-7 h-7 text-gray-600" fill="none"
                        xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                        <g id="SVGRepo_iconCarrier">
                            <path
                                d="M480-80q-75 0-140.5-28T225-185q-49-49-77-114.5T120-440h60q0 125 87.5 212.5T480-140q125 0 212.5-87.5T780-440q0-125-85-212.5T485-740h-22l73 73-42 42-147-147 147-147 41 41-78 78h23q75 0 140.5 28T735-695q49 49 77 114.5T840-440q0 75-28 140.5T735-185q-49 49-114.5 77T480-80ZM380-310v-50h127v-56H380v-155h176v49H430v57h92q14 0 24 10t10 24v87q0 14-10 24t-24 10H380Z"
                                fill="#000000" />
                        </g>
                    </svg>
                </button>
                <button class="p-4 rounded-full bg-gray-200 hover:bg-gray-300 focus:outline-none mx-4" id="playSound">
                    <svg width="64px" height="64px" viewBox="0 0 24 24" class="w-9 h-9 text-gray-600" fill="none"
                        xmlns="http://www.w3.org/2000/svg" id="pause_btn" style="display: none;">
                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                        <g id="SVGRepo_iconCarrier">
                            <path
                                d="M2 6C2 4.11438 2 3.17157 2.58579 2.58579C3.17157 2 4.11438 2 6 2C7.88562 2 8.82843 2 9.41421 2.58579C10 3.17157 10 4.11438 10 6V18C10 19.8856 10 20.8284 9.41421 21.4142C8.82843 22 7.88562 22 6 22C4.11438 22 3.17157 22 2.58579 21.4142C2 20.8284 2 19.8856 2 18V6Z"
                                fill="#000000"></path>
                            <path
                                d="M14 6C14 4.11438 14 3.17157 14.5858 2.58579C15.1716 2 16.1144 2 18 2C19.8856 2 20.8284 2 21.4142 2.58579C22 3.17157 22 4.11438 22 6V18C22 19.8856 22 20.8284 21.4142 21.4142C20.8284 22 19.8856 22 18 22C16.1144 22 15.1716 22 14.5858 21.4142C14 20.8284 14 19.8856 14 18V6Z"
                                fill="#000000"></path>
                        </g>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="64px" height="64px"
                        class="w-9 h-9 text-gray-600" fill="none" id="play_btn">
                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                        <g id="SVGRepo_iconCarrier">
                            <path d="M320-203v-560l440 280-440 280Zm60-280Zm0 171 269-171-269-171v342Z"
                                fill="#000000" />
                        </g>
                    </svg>
                </button>
                <button class="p-3 rounded-full bg-gray-200 hover:bg-gray-300 focus:outline-none" id="next">
                    <svg width="64px" height="64px" viewBox="0 -960 960 960" class="w-7 h-7 text-gray-600" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                        <g id="SVGRepo_iconCarrier">
                            <path
                                d="M480-80q-75 0-140.5-28T225-185q-49-49-77-114.5T120-440q0-75 28-140.5T225-695q49-49 114.5-77T480-800h21l-78-78 41-41 147 147-147 147-41-41 74-74h-17q-125.36 0-212.68 87.32Q180-565.36 180-440q0 125.36 87.32 212.68Q354.64-140 480-140q125.36 0 212.68-87.32Q780-314.64 780-440h60q0 75-28 140.5T735-185q-49 49-114.5 77T480-80ZM380-310v-50h127v-56H380v-155h176v49H430v57h92q14.45 0 24.22 9.77Q556-445.45 556-431v87q0 14.45-9.78 24.23Q536.45-310 522-310H380Z"
                                fill="#000000" />
                        </g>
                    </svg>
                </button>
            </div>
            <!-- Progress Bar -->
            <div class="mt-6 bg-gray-200 h-2 rounded-full cursor-pointer" id="progress-container">
                <div class="bg-red-500 h-2 rounded-full w-0" id="progress-bar"></div>
            </div>
            <!-- Time Information -->
            <div class="flex justify-between mt-2 text-sm text-gray-600">
                <span id="elapsed">00:00</span>
                <span id="total"></span>
            </div>
        </div>
        <!-- Liste des audios -->
        <div class="bg-white p-8 rounded-lg shadow-md flex-1 w-full md:w-20">
            <input id="selectFolder" type="file" webkitdirectory directory multiple class="hidden" />
            <input id="selectFiles" type="file" multiple accept="audio/*" class="hidden" />

            <label for="selectFiles" id="labelFiles"
                class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded mb-4 cursor-pointer hidden">
                Sélectionner des fichiers
            </label>
            <label for="selectFolder" id="labelFolder"
                class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded mb-4 cursor-pointer hidden">
                Sélectionner un dossier
            </label>
            <div id="audioList" class="flex flex-col p-4 mt-4"></div>
        </div>
    </div>

    <!-- Balise audio avec le fichier source -->
    <audio id="audioPlayer" style="display: none;">
        <source type="audio/mpeg">
        Votre navigateur ne supporte pas la balise audio.
    </audio>

    <div x-data="{ isOpen: false }" class="hidden" id="modal">
        <!-- Open modal button -->
        <button x-on:click="isOpen = true" class="px-4 py-2 bg-red-500 text-white rounded-md hidden" id="openModal">
            Open Modal </button>
        <!-- Modal Overlay -->
        <div x-show="isOpen" class="fixed inset-0 px-2 z-10 overflow-hidden flex items-center justify-center">
            <div x-show="isOpen" x-transition:enter="transition-opacity ease-out duration-300"
                x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                x-transition:leave="transition-opacity ease-in duration-300" x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <!-- Modal Content -->
            <div x-show="isOpen" x-transition:enter="transition-transform ease-out duration-300"
                x-transition:enter-start="transform scale-75" x-transition:enter-end="transform scale-100"
                x-transition:leave="transition-transform ease-in duration-300"
                x-transition:leave-start="transform scale-100" x-transition:leave-end="transform scale-75"
                class="bg-white rounded-md shadow-xl overflow-hidden max-w-md w-full sm:w-96 md:w-1/2 lg:w-2/3 xl:w-1/3 z-50">
                <!-- Modal Header -->
                <div class="bg-red-500 text-white px-4 py-2 flex justify-between">
                    <h2 class="text-lg font-semibold" id="modal-title">Modal Title</h2>
                </div>
                <!-- Modal Body -->
                <div class="p-4">
                    <p id="modal-content">This is the content of the modal. You can add any content here. Lorem ipsum
                        dolor sit amet</p>
                </div>
                <!-- Modal Footer -->
                <div class="border-t px-4 py-2 flex justify-end">
                    <button x-on:click="isOpen = false"
                        class="px-3 py-1 bg-red-500 text-white  rounded-md w-full sm:w-auto" id="model-action"> D'accord
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@2.8.2/dist/alpine.min.js" defer></script>

    <script>
        // ==== Sélection des éléments HTML ====

        const elements = {
            playSound: document.getElementById('playSound'),
            audio: document.getElementById('audioPlayer'),
            prev: document.getElementById('prev'),
            next: document.getElementById('next'),
            elapsedSpan: document.getElementById('elapsed'),
            totalSpan: document.getElementById('total'),
            progressBar: document.getElementById('progress-bar'),
            pauseBtn: document.getElementById('pause_btn'),
            playBtn: document.getElementById('play_btn'),
            songTitle: document.getElementById('songTitle'),
            artistName: document.getElementById('artistName'),
            selectFolder: document.getElementById('selectFolder'),
            audioList: document.getElementById('audioList'),
            progressContainer: document.getElementById('progress-container'),
            selectFiles: document.getElementById('selectFiles'),
            labelFiles: document.getElementById('labelFiles'),
            labelFolder: document.getElementById('labelFolder'),
            modalTitle: document.getElementById("modal-title"),
            modalContent: document.getElementById("modal-content"),
            openModal: document.getElementById("openModal"),
            modal:document.getElementById("modal"),
        };

        setTimeout(() => {
            elements.modal.classList.remove('hidden');
        }, 100);

        let audioFiles = [];

        // ==== Mise à jour de la liste des fichiers audio ====
        function updateAudioList() {
            elements.audioList.innerHTML = '';

            if (audioFiles.length > 0) {
                elements.audioList.classList.add("border-l-4", "border-red-500");
            } else {
                elements.audioList.classList.remove("border-l-4", "border-red-500");
            }

            audioFiles.forEach((file, index) => addItemToList(index, file));
            highlightActiveAudio(currentIndex);
        }

        // ==== Ajouter un fichier à la liste ====
        function addItemToList(index, file) {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center border-b py-3 cursor-pointer hover:shadow-md px-2 audio-item';
            div.id = `item-${index}`;
            div.onclick = () => playAudio(index);

            const img = document.createElement('img');
            img.className = 'w-10 h-10 object-cover rounded-lg';
            img.alt = 'Audio file';
            img.src = 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Apple_Music_icon.svg/1200px-Apple_Music_icon.svg.png';

            const textDiv = document.createElement('div');
            textDiv.className = 'flex flex-col px-2 w-full';

            const title = document.createElement('span');
            title.className = 'text-sm text-red-500 capitalize font-semibold pt-1';
            title.textContent = file.name;

            const artist = document.createElement('span');
            artist.className = 'text-xs text-gray-500 uppercase font-medium';
            artist.textContent = 'Artiste inconnu';

            const supButton = document.createElement('ion-icon');
            supButton.className = 'w-6 h-6 cursor-pointer hover:opacity-80 text-red-500';
            supButton.setAttribute('name', 'trash-outline');

            supButton.onclick = (event) => {
                event.stopPropagation();
                handleDelete(index);
            };

            textDiv.appendChild(title);
            textDiv.appendChild(artist);
            div.appendChild(img);
            div.appendChild(textDiv);
            div.appendChild(supButton);
            elements.audioList.appendChild(div);
        }

        // ==== Gestion de la suppression ====
        function handleDelete(index) {
            if (index === currentIndex) {
                // Le fichier est en cours de lecture
                elements.modalTitle.innerText = "Echec de suppression";
                elements.modalContent.innerText = "Le fichier est en cours d'utilisation";
                elements.openModal.click();
                return;
            }

            // Supprimer le fichier et mettre à jour la liste
            audioFiles.splice(index, 1);

            // Ajuster currentIndex si nécessaire
            if (index < currentIndex) {
                currentIndex--; // Décaler l'indice actuel si un fichier avant est supprimé
            }

            // Si plus aucun fichier, arrêter la lecture
            if (audioFiles.length === 0) {
                elements.audio.pause();
                elements.audio.src = '';
                currentIndex = -1;
            } else {
                // Continuer la lecture si besoin
                if (index < currentIndex || (index === currentIndex && currentIndex >= audioFiles.length)) {
                    playAudio(Math.max(0, currentIndex - 1));
                }
            }

            updateAudioList();
        }

        // ==== Mettre en évidence l'audio actif ====
        function highlightActiveAudio(index) {
            document.querySelectorAll('.audio-item').forEach((item, idx) => {
                item.classList.toggle('border-red-500', idx === index);
            });
        }

        // ==== Lecture d'un fichier audio ====
        function playAudio(index) {
            if (index < 0 || index >= audioFiles.length) return;

            if (currentIndex !== index || !elements.audio.src) {
                currentIndex = index;
                elements.audio.src = URL.createObjectURL(audioFiles[index]);
            }

            elements.audio.play();
            togglePlayPauseButton(false);
            highlightActiveAudio(index);
        }

        // ==== Gestion des événements ====
        elements.selectFolder.addEventListener('change', async (event) => {
            try {
                const files = Array.from(event.target.files).filter(file =>
                    file.name.match(/\.(mp3|wav|ogg)$/i)
                );

                audioFiles = files;
                currentIndex = 0;
                updateAudioList();
                elements.selectFolder.value = '';
                if (audioFiles.length > 0) {
                    playAudio(0); // Charger le premier fichier
                }
            } catch (error) {
                console.error('Erreur lors de la sélection des fichiers:', error);
            }
        });

        elements.selectFiles.addEventListener('change', (event) => {
            const files = Array.from(event.target.files);
            audioFiles = files.filter(file => file.type.startsWith('audio/'));
            currentIndex = 0;
            elements.selectFiles.value = '';
            updateAudioList();
            if (audioFiles.length > 0) {
                playAudio(0); // Charger le premier fichier
            }
        });

        elements.audio.addEventListener('loadedmetadata', () => {
            elements.totalSpan.textContent = formatTime(elements.audio.duration);
            elements.songTitle.textContent = audioFiles[currentIndex]?.name.split('.')[0] || '';
            elements.artistName.textContent = 'Artiste inconnu';
        });

        elements.audio.addEventListener('timeupdate', () => {
            elements.elapsedSpan.textContent = formatTime(elements.audio.currentTime);
            elements.progressBar.style.width = `${(elements.audio.currentTime / elements.audio.duration) * 100}%`;
        });

        elements.audio.addEventListener('ended', () => {
            if (currentIndex < audioFiles.length - 1) {
                playAudio(currentIndex + 1);
            } else {
                elements.progressBar.style.width = '0%';
                togglePlayPauseButton(true);
                elements.elapsedSpan.textContent = '00:00';
            }
        });

        elements.playSound.addEventListener('click', () => {
            if (elements.audio.paused && elements.audio.src) {
                playAudio(currentIndex);
            } else {
                elements.audio.pause();
                togglePlayPauseButton(true);
            }
        });

        elements.prev.addEventListener('click', () => {
            elements.audio.currentTime = Math.max(0, elements.audio.currentTime - 5);
        });

        elements.next.addEventListener('click', () => {
            elements.audio.currentTime = Math.min(elements.audio.duration, elements.audio.currentTime + 5);
        });

        elements.audio.addEventListener('pause', () => {
            togglePlayPauseButton(true);
        });

        elements.audio.addEventListener('play', () => {
            togglePlayPauseButton(false);
        });

        let isDragging = false; // Indique si l'utilisateur est en train de cliquer-glisser

        // Début du cliquer-glisser
        elements.progressContainer.addEventListener('mousedown', (event) => {
            isDragging = true;
            setAudioProgress(event); // Mettre à jour dès le clic initial
        });

        // Suivi du glisser
        elements.progressContainer.addEventListener('mousemove', (event) => {
            if (isDragging) {
                setAudioProgress(event); // Mettre à jour pendant le glisser
            }
        });

        // Fin du cliquer-glisser
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
            }
        });

        // (Optionnel) Support des écrans tactiles
        elements.progressContainer.addEventListener('touchstart', (event) => {
            isDragging = true;
            setAudioProgress(event);
        });

        elements.progressContainer.addEventListener('touchmove', (event) => {
            if (isDragging) {
                setAudioProgress(event);
            }
        });

        document.addEventListener('touchend', () => {
            if (isDragging) {
                isDragging = false;
            }
        });

        window.addEventListener('resize', detectDevice);
        detectDevice();

        // ==== Utilitaires ====
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function togglePlayPauseButton(isPlay) {
            elements.playBtn.style.display = isPlay ? 'block' : 'none';
            elements.pauseBtn.style.display = isPlay ? 'none' : 'block';
        }

        // Fonction pour mettre à jour la position de lecture
        function setAudioProgress(event) {
            const containerWidth = elements.progressContainer.offsetWidth;
            const clickX = event.offsetX || event.touches?.[0].clientX - elements.progressContainer.getBoundingClientRect().left;
            const newTime = Math.max(0, Math.min((clickX / containerWidth) * elements.audio.duration, elements.audio.duration));
            const progressPercentage = (newTime / elements.audio.duration) * 100;
            elements.progressBar.style.width = `${progressPercentage}%`;
            elements.audio.currentTime = newTime;
        }

        function detectDevice() {
            const isMobile = window.innerWidth <= 768; // Largeur pour mobiles/tablettes

            if (isMobile) {
                elements.labelFiles.classList.remove('hidden');
                elements.labelFolder.classList.add('hidden');
            } else {
                elements.labelFolder.classList.remove('hidden');
                elements.labelFiles.classList.add('hidden');
            }
        }
    </script>

</body>

</html>